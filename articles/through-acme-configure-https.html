<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>通过 acme.sh 配置 https</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/6b7407e5a7346cc0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6b7407e5a7346cc0.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-266da34e2468c883.js" defer=""></script><script src="/_next/static/chunks/framework-281bd828f4ecdac7.js" defer=""></script><script src="/_next/static/chunks/main-5712a0d871ba0756.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5aa6660ad80e5004.js" defer=""></script><script src="/_next/static/chunks/720-cfd8b9301b1b5f7f.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bslug%5D-e8b991116ca82f6d.js" defer=""></script><script src="/_next/static/UbKi1panY-ACHluoBaE0P/_buildManifest.js" defer=""></script><script src="/_next/static/UbKi1panY-ACHluoBaE0P/_ssgManifest.js" defer=""></script></head><body><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="flex justify-center"><div class="fixed top-4 bg-white z-20 rounded-full dark:bg-slate-800"><nav class="px-2 py-2 flex rounded-full items-center font-semibold bg-transparent shadow-lg dark:shadow-md dark:shadow-slate-800"><a class="nav_link hover:bg-indigo-300 hover:rounded-full hover:text-stone-50" href="/">首页</a><a class="nav_link bg-indigo-700 rounded-full text-white" href="/articles">文章</a><a class="nav_link hover:bg-indigo-300 hover:rounded-full hover:text-stone-50" href="/projects">项目</a><a class="nav_link hover:bg-indigo-300 hover:rounded-full hover:text-stone-50" href="/about">关于</a></nav></div></div><div class="app antialiased pt-28"><div class="mx-6 sm:mx-16 flex-1 max-w-full"><div class="px-1"><div class="flex flex-col justify-center items-center gap-4 px-2"><div class=" font-extrabold text-2xl">通过 acme.sh 配置 https</div><div class="flex gap-4"><div class=" font-medium text-slate-400 ">2020-08-19</div><div class="flex gap-2"><span class="px-2 py-0 leading-7 bg-purple-400 text-white rounded-full text-sm">#<!-- -->ruby</span><span class="px-2 py-0 leading-7 bg-purple-400 text-white rounded-full text-sm">#<!-- -->acme.sh</span><span class="px-2 py-0 leading-7 bg-purple-400 text-white rounded-full text-sm">#<!-- -->nginx</span></div></div></div><div class="mt-4 tracking-wide leading-8 overflow-y-scroll mx-0 px-2 max-w-full prose lg:prose-xl dark:prose-invert"><p>1、 安装acme.sh 如下命令：</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>curl https</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#67cdcc">/</span><span>get</span><span class="token token" style="color:#ccc">.</span><span>acme</span><span class="token token" style="color:#ccc">.</span><span>sh </span><span class="token token" style="color:#67cdcc">|</span><span> sh</span></code></div></pre>
<p>为了能在命令行中执行，在.bashrc中配置：</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">alias</span><span> acme</span><span class="token token" style="color:#ccc">.</span><span>sh</span><span class="token token" style="color:#67cdcc">=~</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#ccc">.</span><span>acme</span><span class="token token" style="color:#ccc">.</span><span>sh</span><span class="token token" style="color:#67cdcc">/</span><span>acme</span><span class="token token" style="color:#ccc">.</span><span>sh</span></code></div></pre>
<p>srouce .bashrc一下就可在控制台中查看acme.sh命令了</p>
<p>acme.sh -h 查看帮助</p>
<p>2、生成dhparams在/etc/nginx/ssl目录下：</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>openssl dhparam </span><span class="token token" style="color:#67cdcc">-</span><span>out </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>dhparams</span><span class="token token" style="color:#ccc">.</span><span>pem </span><span class="token token" style="color:#f08d49">4096</span></code></div></pre>
<p>3、配置nginx可以访问对应域名下的.well-known文件(因为要使对应域名可用)
比如在/var/html/www下创建一个.well-known文件夹</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>location </span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#ccc">.</span><span>well</span><span class="token token" style="color:#67cdcc">-</span><span>known </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>  root </span><span class="token token" style="color:#67cdcc">/</span><span>var</span><span class="token token" style="color:#67cdcc">/</span><span>html</span><span class="token token" style="color:#67cdcc">/</span><span>www</span><span class="token token" style="color:#ccc">;</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span></code></div></pre>
<p>4、颁发证书</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>acme</span><span class="token token" style="color:#ccc">.</span><span>sh </span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#67cdcc">-</span><span>issue </span><span class="token token" style="color:#67cdcc">-</span><span>w  </span><span class="token token" style="color:#67cdcc">/</span><span>var</span><span class="token token" style="color:#67cdcc">/</span><span>html</span><span class="token token" style="color:#67cdcc">/</span><span>www </span><span class="token token" style="color:#67cdcc">-</span><span>d xcx</span><span class="token token" style="color:#ccc">.</span><span>org </span><span class="token token" style="color:#67cdcc">-</span><span>k </span><span class="token token" style="color:#f08d49">4096</span></code></div></pre>
<p>5、生成对应的nginx的配置证书</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>acme</span><span class="token token" style="color:#ccc">.</span><span>sh </span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#67cdcc">-</span><span>install</span><span class="token token" style="color:#67cdcc">-</span><span>cert </span><span class="token token" style="color:#67cdcc">-</span><span>d xcx</span><span class="token token" style="color:#ccc">.</span><span>org </span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#67cdcc">-</span><span>key</span><span class="token token" style="color:#67cdcc">-</span><span>file </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#ccc">.</span><span>org</span><span class="token token" style="color:#ccc">.</span><span>key </span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#67cdcc">-</span><span>fullchain</span><span class="token token" style="color:#67cdcc">-</span><span>file </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#ccc">.</span><span>org</span><span class="token token" style="color:#ccc">.</span><span>cer </span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#67cdcc">-</span><span>reloadcmd </span><span class="token token string-literal" style="color:#7ec699">&#x27;service nginx restart&#x27;</span></code></div></pre>
<p>6、配置对应的nginx</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-rb" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>listen </span><span class="token token" style="color:#f08d49">443</span><span> ssl</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_certificate </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#ccc">.</span><span>org</span><span class="token token" style="color:#ccc">.</span><span>cer </span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_certificate_key </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#67cdcc">/</span><span>xcx</span><span class="token token" style="color:#ccc">.</span><span>org</span><span class="token token" style="color:#ccc">.</span><span>key</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_session_timeout </span><span class="token token" style="color:#f08d49">30</span><span>m</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_protocols TLSv1</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#f08d49">1</span><span> TLSv1</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#f08d49">2</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_ciphers </span><span class="token token" style="color:#f8c555">ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AESGCM</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AESGCM</span><span class="token token" style="color:#f8c555">:ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES256</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES256</span><span class="token token" style="color:#f8c555">:ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES128</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES</span><span class="token token" style="color:#f8c555">:ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f08d49">3</span><span>DES</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f08d49">3</span><span>DES</span><span class="token token" style="color:#f8c555">:RSA</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AESGCM</span><span class="token token" style="color:#f8c555">:RSA</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES</span><span class="token token" style="color:#f8c555">:RSA</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f08d49">3</span><span>DES</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">!</span><span>aNULL</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">!</span><span class="token token" style="color:#f8c555">MD5</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">!</span><span class="token token" style="color:#f8c555">DSS</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_session_cache shared</span><span class="token token" style="color:#f8c555">:SSL</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#f08d49">10</span><span>m</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_dhparam </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>dhparams</span><span class="token token" style="color:#ccc">.</span><span>pem</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>ssl_prefer_server_ciphers on</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>add_header Strict</span><span class="token token" style="color:#67cdcc">-</span><span>Transport</span><span class="token token" style="color:#67cdcc">-</span><span>Security max</span><span class="token token" style="color:#67cdcc">-</span><span>age</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">31536000</span><span class="token token" style="color:#ccc">;</span></code></div></pre>
<p>配置参考</p>
<pre><div style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-ruby" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>upstream talent </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>  server unix</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#67cdcc">/</span><span>data</span><span class="token token" style="color:#67cdcc">/</span><span>talent</span><span class="token token" style="color:#67cdcc">/</span><span>shared</span><span class="token token" style="color:#67cdcc">/</span><span>tmp</span><span class="token token" style="color:#67cdcc">/</span><span>sockets</span><span class="token token" style="color:#67cdcc">/</span><span>puma</span><span class="token token" style="color:#ccc">.</span><span>sock</span><span class="token token" style="color:#ccc">;</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span><span>
</span>
<span>server </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>  listen       </span><span class="token token" style="color:#f08d49">80</span><span> default_server</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  listen </span><span class="token token" style="color:#f08d49">443</span><span> ssl</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  server_name  abc</span><span class="token token" style="color:#ccc">.</span><span>com</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  root </span><span class="token token" style="color:#67cdcc">/</span><span>data</span><span class="token token" style="color:#67cdcc">/</span><span>talent</span><span class="token token" style="color:#67cdcc">/</span><span>current</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#cc99cd">public</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  index index</span><span class="token token" style="color:#ccc">.</span><span>html</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  add_header Access</span><span class="token token" style="color:#67cdcc">-</span><span>Control</span><span class="token token" style="color:#67cdcc">-</span><span>Allow</span><span class="token token" style="color:#67cdcc">-</span><span>Origin </span><span class="token token" style="color:#67cdcc">*</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_prefer_server_ciphers on</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_session_timeout </span><span class="token token" style="color:#f08d49">30</span><span>m</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_protocols TLSv1</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#f08d49">1</span><span> TLSv1</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#f08d49">2</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_ciphers </span><span class="token token" style="color:#f8c555">ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AESGCM</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AESGCM</span><span class="token token" style="color:#f8c555">:ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES256</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES256</span><span class="token token" style="color:#f8c555">:ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES128</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES</span><span class="token token" style="color:#f8c555">:ECDH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f08d49">3</span><span>DES</span><span class="token token" style="color:#f8c555">:DH</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f08d49">3</span><span>DES</span><span class="token token" style="color:#f8c555">:RSA</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AESGCM</span><span class="token token" style="color:#f8c555">:RSA</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f8c555">AES</span><span class="token token" style="color:#f8c555">:RSA</span><span class="token token" style="color:#67cdcc">+</span><span class="token token" style="color:#f08d49">3</span><span>DES</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">!</span><span>aNULL</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">!</span><span class="token token" style="color:#f8c555">MD5</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">!</span><span class="token token" style="color:#f8c555">DSS</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_session_cache shared</span><span class="token token" style="color:#f8c555">:SSL</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#f08d49">10</span><span>m</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_prefer_server_ciphers on</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  add_header Strict</span><span class="token token" style="color:#67cdcc">-</span><span>Transport</span><span class="token token" style="color:#67cdcc">-</span><span>Security max</span><span class="token token" style="color:#67cdcc">-</span><span>age</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">31536000</span><span class="token token" style="color:#ccc">;</span><span>
</span>
<!-- -->
<span>  ssl_certificate </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>talent</span><span class="token token" style="color:#67cdcc">/</span><span>abc</span><span class="token token" style="color:#ccc">.</span><span>com</span><span class="token token" style="color:#ccc">.</span><span>cer</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_certificate_key  </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>talent</span><span class="token token" style="color:#67cdcc">/</span><span>abc</span><span class="token token" style="color:#ccc">.</span><span>com</span><span class="token token" style="color:#ccc">.</span><span>key</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  ssl_dhparam </span><span class="token token" style="color:#67cdcc">/</span><span>etc</span><span class="token token" style="color:#67cdcc">/</span><span>nginx</span><span class="token token" style="color:#67cdcc">/</span><span>ssl</span><span class="token token" style="color:#67cdcc">/</span><span>talent</span><span class="token token" style="color:#67cdcc">/</span><span>dhparams</span><span class="token token" style="color:#ccc">.</span><span>pem</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  try_files </span><span class="token token" style="color:#7ec699">$uri</span><span class="token token" style="color:#67cdcc">/</span><span>index</span><span class="token token" style="color:#ccc">.</span><span>html </span><span class="token token" style="color:#7ec699">$uri</span><span class="token token" style="color:#ccc">.</span><span>html </span><span class="token token" style="color:#7ec699">$uri</span><span> </span><span class="token token" style="color:#7ec699">@talent</span><span class="token token" style="color:#ccc">;</span><span>
</span>
<span>  location </span><span class="token token" style="color:#7ec699">@talent</span><span> </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>    proxy_set_header   Host </span><span class="token token" style="color:#7ec699">$host</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    proxy_set_header   </span><span class="token token" style="color:#f8c555">X</span><span class="token token" style="color:#67cdcc">-</span><span>Forwarded</span><span class="token token" style="color:#67cdcc">-</span><span>Host </span><span class="token token" style="color:#7ec699">$host</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    proxy_set_header   </span><span class="token token" style="color:#f8c555">X</span><span class="token token" style="color:#67cdcc">-</span><span>Forwarded</span><span class="token token" style="color:#67cdcc">-</span><span>Server </span><span class="token token" style="color:#7ec699">$host</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    proxy_set_header   </span><span class="token token" style="color:#f8c555">X</span><span class="token token" style="color:#67cdcc">-</span><span>Real</span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#f8c555">IP</span><span>        </span><span class="token token" style="color:#7ec699">$remote_addr</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    proxy_set_header   </span><span class="token token" style="color:#f8c555">X</span><span class="token token" style="color:#67cdcc">-</span><span>Forwarded</span><span class="token token" style="color:#67cdcc">-</span><span>For  </span><span class="token token" style="color:#7ec699">$proxy_add_x_forwarded_for</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    proxy_pass         http</span><span class="token token" style="color:#67cdcc">:</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#67cdcc">/</span><span>talent</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">}</span><span>
</span>
<span>  location </span><span class="token token" style="color:#67cdcc">~</span><span> </span><span class="token token" style="color:#67cdcc">^</span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#ccc">(</span><span>assets</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#67cdcc">/</span><span> </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>    gzip_static on</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    expires max</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    add_header Cache</span><span class="token token" style="color:#67cdcc">-</span><span>Control </span><span class="token token" style="color:#cc99cd">public</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">}</span><span>
</span><span>  error_page </span><span class="token token" style="color:#f08d49">404</span><span> </span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#f08d49">404.</span><span>html</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      location </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#f08d49">400.</span><span>html </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">}</span><span>
</span>
<span>  error_page </span><span class="token token" style="color:#f08d49">500</span><span> </span><span class="token token" style="color:#f08d49">502</span><span> </span><span class="token token" style="color:#f08d49">503</span><span> </span><span class="token token" style="color:#f08d49">504</span><span> </span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#f08d49">500.</span><span>html</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      location </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#67cdcc">/</span><span class="token token" style="color:#f08d49">500.</span><span>html </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">}</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span></code></div></pre></div></div></div><footer class="w-full border-t mt-8"><div class="border-t border-salte-100 pb-8 pt-4 dark:border-slate-900"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800 dark:text-zinc-200"><a class="transition hover:text-indigo-500" href="/articles">文章</a><a class="transition hover:text-indigo-500" href="/projects">项目</a><a class="transition hover:text-indigo-500" href="/about">关于</a></div><p class="text-sm text-zinc-400 dark:text-zinc-500">© 2023 Xcplus. 保留所有权.</p></div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"articleData":{"markdownContent":"\n1、 安装acme.sh 如下命令：\n\n```rb\ncurl https://get.acme.sh | sh\n```\n为了能在命令行中执行，在.bashrc中配置：\n\n```rb\nalias acme.sh=~/.acme.sh/acme.sh\n```\nsrouce .bashrc一下就可在控制台中查看acme.sh命令了\n\nacme.sh -h 查看帮助\n\n2、生成dhparams在/etc/nginx/ssl目录下：\n\n```rb\nopenssl dhparam -out /etc/nginx/ssl/dhparams.pem 4096\n```\n3、配置nginx可以访问对应域名下的.well-known文件(因为要使对应域名可用)\n比如在/var/html/www下创建一个.well-known文件夹\n\n```rb\nlocation /.well-known {\n  root /var/html/www;\n}\n```\n4、颁发证书\n\n```rb\nacme.sh --issue -w  /var/html/www -d xcx.org -k 4096\n```\n\n5、生成对应的nginx的配置证书\n\n```rb\nacme.sh --install-cert -d xcx.org --key-file /etc/nginx/ssl/xcx/xcx.org.key --fullchain-file /etc/nginx/ssl/xcx/xcx.org.cer --reloadcmd 'service nginx restart'\n```\n6、配置对应的nginx\n\n```rb\nlisten 443 ssl;\nssl_certificate /etc/nginx/ssl/xcx/xcx.org.cer ;\nssl_certificate_key /etc/nginx/ssl/xcx/xcx.org.key;\nssl_session_timeout 30m;\nssl_protocols TLSv1.1 TLSv1.2;\nssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;\nssl_session_cache shared:SSL:10m;\nssl_dhparam /etc/nginx/ssl/dhparams.pem;\nssl_prefer_server_ciphers on;\nadd_header Strict-Transport-Security max-age=31536000;\n```\n\n\n配置参考\n\n```ruby\nupstream talent {\n  server unix:///data/talent/shared/tmp/sockets/puma.sock;\n}\n\nserver {\n  listen       80 default_server;\n  listen 443 ssl;\n  server_name  abc.com;\n  root /data/talent/current/public;\n  index index.html;\n  add_header Access-Control-Allow-Origin *;\n  ssl_prefer_server_ciphers on;\n  ssl_session_timeout 30m;\n  ssl_protocols TLSv1.1 TLSv1.2;\n  ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;\n  ssl_session_cache shared:SSL:10m;\n  ssl_prefer_server_ciphers on;\n  add_header Strict-Transport-Security max-age=31536000;\n\n\n  ssl_certificate /etc/nginx/ssl/talent/abc.com.cer;\n  ssl_certificate_key  /etc/nginx/ssl/talent/abc.com.key;\n  ssl_dhparam /etc/nginx/ssl/talent/dhparams.pem;\n  try_files $uri/index.html $uri.html $uri @talent;\n\n  location @talent {\n    proxy_set_header   Host $host;\n    proxy_set_header   X-Forwarded-Host $host;\n    proxy_set_header   X-Forwarded-Server $host;\n    proxy_set_header   X-Real-IP        $remote_addr;\n    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n    proxy_pass         http://talent;\n  }\n\n  location ~ ^/(assets)/ {\n    gzip_static on;\n    expires max;\n    add_header Cache-Control public;\n  }\n  error_page 404 /404.html;\n      location = /400.html {\n  }\n\n  error_page 500 502 503 504 /500.html;\n      location = /500.html {\n  }\n}\n```","title":"通过 acme.sh 配置 https","slug":"through-acme-configure-https","intro":"为了网站安全，我们经常会给我们的域名配置并启用https，使我们的网站更加安全，如今有很多可以自动生成证书的工具，比如：acme.sh、Certbot等，由于经常性的使用，所以写一下使用acme.sh的方法和配置","tags":"ruby, acme.sh, nginx","date":"2020-08-19"}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"through-acme-configure-https"},"buildId":"UbKi1panY-ACHluoBaE0P","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>